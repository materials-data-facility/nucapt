# NUCAPT Publication Manager
[![Build Status](https://travis-ci.org/materials-data-facility/nucapt.svg?branch=master)](https://travis-ci.org/materials-data-facility/nucapt)[![Coverage Status](https://coveralls.io/repos/github/materials-data-facility/nucapt/badge.svg?branch=master)](https://coveralls.io/github/materials-data-facility/nucapt?branch=master)
[![Documentation Status](https://readthedocs.org/projects/nucapt/badge/?version=latest)](http://nucapt.readthedocs.io/en/latest/?badge=latest)

The NUCAPT publication manager is designed to organize data produced by the Northwestern University Atom Probe
Tomography (NUCAPT) facility. The primary functions of this service are to create and maintain an organized filesystem,
and assist gathering metadata about each APT sample. Both of these functions will serve to make this data more
resuable and will simplify publication to the [Materials Data Facility](http://materialsdatafacility.org).

## Docker Deployment
The service is deployed using a docker image based on 
[tiangolo/uwsgi-nginx-flask-docker](https://github.com/tiangolo/uwsgi-nginx-flask-docker).
This image hosts the flask app behind an Nginx instance. 

It expects two volumes to be mounted into the container:
1. `/config` - This directory must contain app.conf configuration file
2. `/working-data` - This is the directory that the app stores the MDF metadata
for the datasets. It is assumed that there is a globus endpoint in front of this
directory and that paths in the endpoint are the same as paths inside this directory.

For example:
```shell script
docker run -d -p 80:80 --mount "type=bind,source=$PWD/conf,destination=/conf" --mount "type=bind,source=$PWD/working-data,destination=/working-data" materialsdatafacility/nucaptdms:develop
```

## Configuration File
There is a sample config file in the repo under [config/app.conf.template](config/app.conf.template).
You should use this as a starting point for your `config/app.conf`. This file is 
in `.gitignore` so you don't accidentally check credentials in. 

These are the properties that are most often customized:
| Property | Description |
|----------|-------------|
| PORTAL_CLIENT_SECRET | Secret key generated by Globus developer portal for your app  |
| PORTAL_CLIENT_ID     | Application client ID as generated by Globus developer portal |
| AUTH_CALLBACK_URL    | URL for Globus Auth to return control back to our app. Must match the setting in the Globus Develoer portal for this app |

## Development
You can build the docker image with the command:
```shell script
 docker build -t materialsdatafacility/nucaptdms:develop .
```

### Setting up OAuth
This part is a bit tricky, but with some friendly tools it can be accomplished 
and you can log into your development app using Globus Auth.

#### Obtaining a Public https Endpoint
You can use [NGrok](http://ngrok.com) to create TLS terminated tunnel to your 
running app. Follow the installation instructions and then launch a session 
with the command:
```shell script
ngrok http 80
```

Make a note of the generated https url.

Set `AUTH_CALLBACK_URL` in your app.config to be this url with `/authcallback` 
appended

#### Set up app in Globus
Visit [http://developers.globus.org](http://developers.globus.org) and select
_Register you app with Globus_. Create a project as needed. Within that project 
select _Add new app_.

Give your app a name.

Set the scopes to include:
```shell script
urn:globus:auth:scope:transfer.api.globus.org:all (Manage data using Globus Transfer)
openid (View your identity)
email (View your email address)
profile (View identity details)
https://auth.globus.org/scopes/ab24b500-37a2-4bad-ab66-d8232c18e6e5/publish_api (Data Publication API)
```
 
Add your `/authcallback` URL to the Redirects field.

Click _Create App_

Paste the generated _Client ID_ into your config's `PORTAL_CLIENT_ID`. Generate
a new client secret and paste the generated value into your config's 
`PORTAL_CLIENT_SECRET` 

#### Running
Everything is now ready to run! 

```shell script
docker run --rm -it -p 80:80  --mount "type=bind,source=$PWD/conf,destination=/conf" --mount "type=bind,source=$PWD/working-data,destination=/working-data" nucapt
```

This will run the docker image, picking up config from `app.conf` in the 
project's `conf` directory. The datasets will be stored in the project's 
`working-data` subdirectory.

You can access the app through the https URL generated by Ngrok.

#### Running Outside of Docker
For serious development you will want to quickly try out code changes. To do 
this you will need to create a python virtual environment and install 
the dependencies found in `requirements.txt` and `requirements_dev.txt`.

```shell script
APP_CONFIG_FILE=../../conf/app.conf PYTHONPATH=app python app/nucapt/main.py
```

#### Running Unit Tests
The NUCAPT DMS is supported by a series of unit tests. These can be run with 
the command:
```shell script
 PYTHONPATH=app nosetests
```

## Using NUCAPT Publication Manager

Documentation is available on [nucapt.readthedocs.io](http://nucapt.readthedocs.io/en/latest/)

## Support
This work was performed under financial assistance award 70NANB14H012 from U.S. Department of Commerce,
National Institute of Standards and Technology as part of the [Center for Hierarchical Material Design (CHiMaD)](http://chimad.northwestern.edu).
